<style>
  .inp {
    background-color: transparent;
    border: 0px solid;
    height: 30px;
    width: 200px;
  }

  .inp:focus {
    outline: none;
  }

  .hidden-button {
    display: none;
  }
</style>



<div class="goto-here">
  <div class="hero-wrap hero-bread" style="background-image: url('images/bg_6.jpg');">
    <div class="container">
      <div class="row no-gutters slider-text align-items-center justify-content-center">
        <div class="col-md-9 ftco-animate text-center">
          <p class="breadcrumbs"><span class="mr-2"><a href="index.html">Home</a></span> <span>Checkout</span></p>
          <h1 class="mb-0 bread">Checkout</h1>
        </div>
      </div>
    </div>
  </div>

  <section class="ftco-section">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-xl-10 ftco-animate">
          <h3 class="text-center">Billing Details</h3>

          <form class="border p-3 " id="myForm">

            <div class=" row w-100 p-1  ">
              {{#each address}}

              <div class="card " style="width: 17.8rem; margin-right: 8px; background-color: rgb(255, 255, 255);">

                <div class="card-body">
                  <div class="d-flex justify-content-between  px-2 mb-2 ">
                    <a href="/editaddress/?id={{_id}}" style=" font-weight: bold;">Edit</a>
                    <a href="/deleteaddress/?id={{_id}}" style="font-weight: bold;">Delete</a>
                  </div>
                  <h6 class="card-title m-0 text-dark">{{name}}</h6>
                  <p class="card-text m-0">{{address}}</p>
                  <p class="card-text m-0">{{city}},{{state}},{{country}}</p>
                  <p class="card-text m-0">{{pin}}</p>
                  <p class="card-text">Mob:+91{{mobile}}</p>



                  {{#if status}}
                  <div class="d-flex pl-2 pt-1">
                    <a href="" class="center "><input type="radio" checked="checked"><span class="pl-1"
                        style=" font-weight: bold;font-size: 16px;">deliver to this address</span></a>
                  </div>
                  {{else}}
                  <div class="d-flex pl-2 pt-1 ">
                    <a href="/selectaddress/?id={{_id}}" class="center"><input id="myRadio" name="ad" type="radio"></a>
                  </div>
                  {{/if}}



                </div>
              </div>
              {{/each}}
            </div>

            <div class="w-100 h-20 p-3">
              <div class="col-md-12">
                <a style="background-color: rgb(2, 3, 2);" class="btn btn-primary p-2" href="/addressSelection">Add new
                  Address</a>
              </div>

            </div>



            <div class="row mt-5 pt-3 d-flex">
              <div class="col-md-6 d-flex">
                <div class="cart-detail cart-total bg-light p-3 p-md-4">
                  <h3 class="billing-heading mb-4">Cart Total</h3>
                  <p class="d-flex">
                    <span>Subtotal</span>
                    <span id="total">{{totalAmount}}</span>

                  </p>
                  <p class="d-flex">
                    <span>Delivery</span>
                    <span>0.00</span>
                  </p>
                  <p class="d-flex">
                    <span>Discount</span>
                    <span id="discount-amount">0</span>
                  </p>
                  <hr>
                  <p class="d-flex total-price">
                    <span>Total</span>
                    {{!-- <input class="inp" id="total-amount" type="text" class="" value="{{totalAmount}}"> --}}
                    <span id="total-amount">{{totalAmount}}</span>
                  </p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="cart-detail bg-light p-3 p-md-4">
                  <h3 class="billing-heading mb-4">Payment Method</h3>
                  <div class="form-group">
                    <div class="col-md-12">
                      <div class="radio">
                        <label><input type="radio" name="payment" value="COD" class="mr-2" />
                          Cash On Delivery</label>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-md-12">
                      <div class="radio">
                        <label><input value="Online" type="radio" name="payment" class="mr-2" />
                          Online</label>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-md-12">
                      <div class="radio">
                        <label><input value="Wallet" type="radio" name="payment" class="mr-2" />
                          Wallet</label>
                      </div>
                    </div>
                  </div>

                  {{!-- <div class="form-group">
                    <div class="col-md-12">
                      <div class="checkbox">
                        <label><input type="checkbox" value="" class="mr-2"> I have read and accept the terms and
                          conditions</label>
                      </div>
                    </div>
                  </div> --}}
                  <button id="place-order-btn" class="btn btn-primary" type="submit">Place Order</button>

                  <div class="d-flex justify-content-center mt-2">
                  <span id="wallet-message" class="text-center"
                        style="font-size: 20px; color: red;font-weight: bold;"></span></span>

                    {{#if adressnull}}
                    <span><i style="font-size: 20px;"
                        class="bi bi-exclamation-triangle-fill text-warning mr-2"></i><span class="text-center"
                        style="font-size: 20px; color: red;font-weight: bold;">Please Add Address</span></span>
                    {{/if}}
                  </div>
                </div>
              </div>
            </div>

          </form>
          <div class="row ">
            <div class=" col-md-6 col-12 input-group p-4">
              <input type="text" id="code" class="form-control" placeholder="Coupon Code" />
              <div class="input-group-append">
                <button  id="apply-btn" onclick="applyCoupon($('#code').val())" style="background-color: black; color: rgb(254, 254, 254);font-weight:bold;">Apply</button>
              <a href="/removecoupon"><button id="my-button" class="hidden-button" style="background-color: black; color: rgb(255, 0, 0);font-weight:bold; padding: 10px 10px 10px 10px;font-size: 16px;">Remove coupon</button></a>

              </div>

            </div>
          </div>
        </div> <!-- .col-md-8 -->
      </div>
    </div>

  </section> <!-- .section -->




  <footer class="ftco-footer ftco-section">
    <div class="container">
      <div class="row">
        <div class="mouse">
          <a href="#" class="mouse-icon">
            <div class="mouse-wheel"><span class="ion-ios-arrow-up"></span></div>
          </a>
        </div>
      </div>
      <div class="row mb-5">
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">Minishop</h2>
            <p>Far far away, behind the word mountains, far from the countries Vokalia and Consonantia.</p>
            <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
              <li class="ftco-animate"><a href="#"><span class="icon-twitter"></span></a></li>
              <li class="ftco-animate"><a href="#"><span class="icon-facebook"></span></a></li>
              <li class="ftco-animate"><a href="#"><span class="icon-instagram"></span></a></li>
            </ul>
          </div>
        </div>
        <div class="col-md">
          <div class="ftco-footer-widget mb-4 ml-md-5">
            <h2 class="ftco-heading-2">Menu</h2>
            <ul class="list-unstyled">
              <li><a href="#" class="py-2 d-block">Shop</a></li>
              <li><a href="#" class="py-2 d-block">About</a></li>
              <li><a href="#" class="py-2 d-block">Journal</a></li>
              <li><a href="#" class="py-2 d-block">Contact Us</a></li>
            </ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">Help</h2>
            <div class="d-flex">
              <ul class="list-unstyled mr-l-5 pr-l-3 mr-4">
                <li><a href="#" class="py-2 d-block">Shipping Information</a></li>
                <li><a href="#" class="py-2 d-block">Returns &amp; Exchange</a></li>
                <li><a href="#" class="py-2 d-block">Terms &amp; Conditions</a></li>
                <li><a href="#" class="py-2 d-block">Privacy Policy</a></li>
              </ul>
              <ul class="list-unstyled">
                <li><a href="#" class="py-2 d-block">FAQs</a></li>
                <li><a href="#" class="py-2 d-block">Contact</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">Have a Questions?</h2>
            <div class="block-23 mb-3">
              <ul>
                <li><span class="icon icon-map-marker"></span><span class="text">203 Fake St. Mountain View, San
                    Francisco, California, USA</span></li>
                <li><a href="#"><span class="icon icon-phone"></span><span class="text">+2 392 3929 210</span></a></li>
                <li><a href="#"><span class="icon icon-envelope"></span><span
                      class="text">info@yourdomain.com</span></a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12 text-center">

          <p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            Copyright &copy;
            <script>document.write(new Date().getFullYear());</script> All rights reserved
            <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
          </p>
        </div>
      </div>
    </div>
  </footer>



  <!-- loader -->
  <div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px">
      <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee" />
      <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10"
        stroke="#F96D00" />
    </svg></div>

</div>
<!-- Add the following line in the head section of your HTML document -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
<!-- <script>
  document.getElementById("my-button").addEventListener("click", function () {
    location.reload();
  });
</script> -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var radioButtons = document.querySelectorAll('input[type="radio"][name="ad"]');
    radioButtons.forEach(function (radioBtn) {
      radioBtn.addEventListener('click', function (event) {
        event.preventDefault();
        var url = event.target.parentNode.getAttribute('href');
        window.location.href = url;
      });
    });
  });
</script>

<script>


$(document).ready(function() {
  $('#myForm').submit(function(event) {
    event.preventDefault(); // Prevent the default form submission

    var paymentMethod = $('input[name="payment"]:checked').val();
    var totalAmount = $('#total-amount').text();


      $.ajax({
        type: 'POST',
        url: '/placeorder',
        data: {

          payment: paymentMethod,
          totalamount: totalAmount
        },
        success: function (data) {
          if (data.url) {
            window.location.replace(data.url);
          } else if(data.lowfund){
            $('#wallet-message').text("Insufficient amount in wallet")
            setTimeout(()=>{
                $('#wallet-message').text("")
            },5000)

          }
          else {
            razorPayment(data)
          } 
        },
        error: function (xhr, textStatus, error) {
         
          console.log(xhr.statusText + ': ' + xhr.responseText);
        }
      });
    });
  });

  function razorPayment(value) {
    const order = value.razorpayDetails
    // razor pay
    var options = {
      "key": "rzp_test_1qaKi1mXcnedgJ", // Enter the Key ID generated from the Dashboard
      "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      "currency": "INR",
      "name": "Acme Corp", //your business name
      "description": "Test Transaction",
      "image": "https://example.com/your_logo",
      "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      "callback_url": "https://eneqd3r9zrjok.x.pipedream.net/",
      "handler": function (response) {
        veryfyPayment(response, order)
      },
      "prefill": {
        "name": "Gaurav Kumar", //your customer's name
        "email": "gaurav.kumar@example.com",
        "contact": "9000090000"
      },
      "notes": {
        "address": "Razorpay Corporate Office"
      },
      "theme": {
        "color": "#3399cc"
      }
    };
    var rzp1 = new Razorpay(options);
    rzp1.open();
    // razor pay
  }

  function veryfyPayment(payment, order) {

    $.ajax({
      url: "/success",
      method: "post",
      data: { order, payment },
      success: function (response) {
        // Redirect the user to the new URL returned from the server
        window.location.replace(response.url);
      }

    })
  }


</script>
<script>
  function applyCoupon(code) {
    let amount = document.getElementById("total").innerHTML
    console.log(amount);
    $.ajax({
      url: '/applycoupon',
      method: 'post',
      data: {
        code: code,
        amount: amount
      },
      success: (response) => {
        if (response.invalid) {
          swal("Oops!", "Coupon not found.", "error");
        } else if (response.expire) {
          swal("Oops!", "Coupon has expired.", "error");
        } else if (response.cartamount) {
          swal("Oops!", "Minimum Amount.", "error");

        } else if (response.user) {
          swal("Oops!", "Coupon used", "error");
        }
        else if (response.couponokey) {
          // document.getElementById("coupondiscount").innerHTML = `${response.discountvalue}% <p style="color:green">Discount added</p>`;
          document.getElementById("total-amount").innerHTML = `${response.distotal}`
          document.getElementById("discount-amount").innerHTML = `${response.discount}`
          var myButton = document.getElementById("my-button");
          myButton.style.display = "block";

          
          var applyButton = document.getElementById("apply-btn");
          applyButton.style.display = "none";
  

          swal("Success!", "Coupon Added.", "success");
        }


      }
    })

  }
</script>